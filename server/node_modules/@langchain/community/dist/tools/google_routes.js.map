{"version":3,"file":"google_routes.js","names":[],"sources":["../../src/tools/google_routes.ts"],"sourcesContent":["import { StructuredTool } from \"@langchain/core/tools\";\nimport { getEnvironmentVariable } from \"@langchain/core/utils/env\";\nimport { InferInteropZodOutput } from \"@langchain/core/utils/types\";\nimport { z } from \"zod/v3\";\n\n/**\n * Interfaces for the response from the Google Routes API.\n */\ninterface Arrival {\n  arrivalTime: string;\n  localizedTime: string;\n  localizedTimezone: string;\n  arrivalAddress: string;\n}\n\ninterface Departure {\n  departureTime: string;\n  localizedTime: string;\n  localizedTimezone: string;\n  departureAddress: string;\n}\n\ninterface transitDetails {\n  transitName?: string;\n  transitNameCode?: string;\n  transitVehicleType: string;\n}\n\ninterface travelInstructions {\n  navigationInstruction: string;\n  travelMode: string;\n}\n\ninterface localizedValues {\n  distance: string;\n  duration: string;\n  transitFare?: string;\n}\n\ninterface TollInfo {\n  currencyCode: string;\n  value: string;\n}\n\n/**\n * Interface for the output of the tool for a transit route.\n */\ninterface FilteredTransitRoute {\n  departure: Departure;\n  arrival: Arrival;\n  travelInstructions: travelInstructions[];\n  localizedValues: localizedValues;\n  transitDetails: transitDetails;\n  routeLabels: string[];\n  warnings?: string[];\n}\n\n/**\n * Interface for the output of the tool for a non-transit route.\n * This includes driving, walking, bicycling, and two-wheeler routes.\n */\ninterface FilteredRoute {\n  description: string;\n  distance: string;\n  duration: string;\n  routeLabels: string[];\n  warnings?: string[];\n  tollInfo?: TollInfo;\n}\n\n/**\n * Interface for the body of the request to the Google Routes API.\n */\ninterface Body {\n  origin: {\n    address: string;\n  };\n  destination: {\n    address: string;\n  };\n  travel_mode: string;\n  routing_preference?: string;\n  computeAlternativeRoutes: boolean;\n  departureTime?: string;\n  arrivalTime?: string;\n  transitPreferences?: {\n    routingPreference: string;\n  };\n  extraComputations?: string[];\n}\n\nconst getTimezoneOffsetInHours = () => {\n  const offsetInMinutes = new Date().getTimezoneOffset();\n  const offsetInHours = -offsetInMinutes / 60;\n  return offsetInHours;\n};\n\n/**\n * Helper functions to create the response objects for the Google Routes API.\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createDeparture(transitDetails: any): Departure {\n  const { stopDetails, localizedValues } = transitDetails;\n  return {\n    departureTime: stopDetails.departureTime,\n    localizedTime: localizedValues.departureTime.time.text,\n    localizedTimezone: localizedValues.departureTime.timeZone,\n    departureAddress: stopDetails.departureStop.name,\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createArrival(transitDetails: any): Arrival {\n  const { stopDetails, localizedValues } = transitDetails;\n  return {\n    arrivalTime: stopDetails.arrivalTime,\n    localizedTime: localizedValues.arrivalTime.time.text,\n    localizedTimezone: localizedValues.arrivalTime.timeZone,\n    arrivalAddress: stopDetails.arrivalStop.name,\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createTravelInstructions(stepsOverview: any): travelInstructions[] {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  return stepsOverview.multiModalSegments.map((segment: any) => ({\n    ...(segment.navigationInstruction\n      ? {\n          navigationInstruction: segment.navigationInstruction.instructions,\n        }\n      : {}),\n    travelMode: segment.travelMode,\n  }));\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createLocalizedValues(route: any): localizedValues {\n  const { distance, duration, transitFare } = route.localizedValues;\n  return {\n    distance: distance.text,\n    duration: duration.text,\n    ...(transitFare?.text ? { transitFare: transitFare.text } : {}),\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createTransitDetails(transitDetails: any): transitDetails {\n  const { name, nameShort, vehicle } = transitDetails.transitLine;\n  return {\n    ...(name ? { transitName: name } : {}),\n    ...(nameShort ? { transitNameCode: nameShort } : {}),\n    transitVehicleType: vehicle.type,\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction createRouteLabel(route: any): string[] {\n  return route.routeLabels;\n}\n\nfunction filterRoutes(\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  route: any,\n  travel_mode: string\n): FilteredTransitRoute | FilteredRoute {\n  if (travel_mode === \"TRANSIT\") {\n    const transitStep = route.legs[0].steps.find(\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (step: any) => step.transitDetails\n    );\n    const filteredRoute: FilteredTransitRoute = {\n      departure: createDeparture(transitStep.transitDetails),\n      arrival: createArrival(transitStep.transitDetails),\n      travelInstructions: createTravelInstructions(route.legs[0].stepsOverview),\n      localizedValues: createLocalizedValues(route),\n      transitDetails: createTransitDetails(transitStep.transitDetails),\n      routeLabels: createRouteLabel(route),\n    };\n    if (route.warnings && route.warnings.length > 0) {\n      filteredRoute.warnings = route.warnings;\n    }\n    return filteredRoute;\n  } else {\n    const filteredRoute: FilteredRoute = {\n      description: route.description,\n      routeLabels: createRouteLabel(route),\n      ...createLocalizedValues(route),\n    };\n    if (route.warnings && route.warnings.length > 0) {\n      filteredRoute.warnings = route.warnings;\n    }\n    if (route.travelAdvisory && route.travelAdvisory.tollInfo) {\n      filteredRoute.tollInfo = {\n        currencyCode:\n          route.travelAdvisory.tollInfo.estimatedPrice[0].currencyCode,\n        value: route.travelAdvisory.tollInfo.estimatedPrice[0].units,\n      };\n    }\n    return filteredRoute;\n  }\n}\n\n/**\n * Interface for parameter s required by GoogleRoutesAPI class.\n */\nexport interface GoogleRoutesAPIParams {\n  apiKey?: string;\n}\n\nconst defaultGoogleRoutesSchema = z.object({\n  origin: z\n    .string()\n    .describe(`Origin address, can be either a place or an address.`),\n  destination: z\n    .string()\n    .describe(`Destination address, can be either a place or an address.`),\n  travel_mode: z\n    .enum([\"DRIVE\", \"WALK\", \"BICYCLE\", \"TRANSIT\", \"TWO_WHEELER\"])\n    .describe(`The mode of transport`),\n  computeAlternativeRoutes: z\n    .boolean()\n    .describe(\n      `Compute alternative routes, set to true if user wants multiple routes, false otherwise.`\n    ),\n  departureTime: z\n    .string()\n    .optional()\n    .describe(\n      `Time that the user wants to depart.\n      There cannot be a departure time if an arrival time is specified.\n      Expected departure time should be provided as a timestamp in RFC3339 format: YYYY-MM-DDThh:mm:ss+00:00. The date should be in UTC time and the +00:00 represents the UTC offset. \n      For instance, if the the user's timezone is -5, the offset would be -05:00 meaning YYYY-MM-DDThh:mm:ss-05:00 with YYYY-MM-DDThh:mm:ss being in UTC. \n      For reference, here is the current time in UTC: ${new Date().toISOString()} and the user's timezone offset is ${getTimezoneOffsetInHours()}. \n      If the departure time is not specified it should not be included.          \n      `\n    ),\n  arrivalTime: z\n    .string()\n    .optional()\n    .describe(\n      `Time that the user wants to arrive.\n      There cannot be an arrival time if a departure time is specified.\n      Expected arrival time should be provided as a timestamp in RFC3339 format: YYYY-MM-DDThh:mm:ss+00:00. The date should be in UTC time and the +00:00 represents the UTC offset. \n      For instance, if the the user's timezone is -5, the offset would be -05:00 meaning YYYY-MM-DDThh:mm:ss-05:00 with YYYY-MM-DDThh:mm:ss being in UTC. \n      For reference, here is the current time in UTC: ${new Date().toISOString()} and the user's timezone offset is ${getTimezoneOffsetInHours()}. \n      Reminder that the arrival time must be in the future, if the user asks for a arrival time in the past instead of processing the request, warn them that it is not possible to calculate a route for a past time.\n      If the user asks for a arrival time in a passed hour today, calculate it for the next day.\n      If the arrival time is not specified it should not be included. `\n    ),\n  transitPreferences: z\n    .object({\n      routingPreference: z.enum([\"LESS_WALKING\", \"FEWER_TRANSFERS\"])\n        .describe(`Transit routing preference.\n        By default, it should not be included.`),\n    })\n    .optional()\n    .describe(\n      `Transit routing preference.\n       By default, it should not be included.`\n    ),\n  extraComputations: z\n    .array(z.enum([\"TOLLS\"]))\n    .optional()\n    .describe(`Calculate tolls for the route.`),\n});\n\n/**\n * Class for interacting with the Google Routes API\n * It extends the StructuredTool class to perform retrieval.\n */\nexport class GoogleRoutesAPI extends StructuredTool {\n  static lc_name() {\n    return \"GoogleRoutesAPI\";\n  }\n\n  get lc_secrets(): { [key: string]: string } | undefined {\n    return {\n      apiKey: \"GOOGLE_ROUTES_API_KEY\",\n    };\n  }\n\n  name: string;\n\n  description: string;\n\n  protected apiKey: string;\n\n  schema: typeof defaultGoogleRoutesSchema = defaultGoogleRoutesSchema;\n\n  constructor(fields?: GoogleRoutesAPIParams) {\n    super(...arguments);\n    const apiKey =\n      fields?.apiKey ?? getEnvironmentVariable(\"GOOGLE_ROUTES_API_KEY\");\n    if (apiKey === undefined) {\n      throw new Error(\n        `Google Routes API key not set. You can set it as \"GOOGLE_ROUTES_API_KEY\" in your environment variables.`\n      );\n    }\n    this.apiKey = apiKey;\n    this.name = \"google_routes\";\n    this.description = `\n    This tool retrieves routing info using the Google Routes API for driving, walking, biking, transit, and two-wheeler routes. Get departure/arrival times, travel instructions, transit fare, warnings, alternative routes, tolls prices, and routing preferences like less walking or fewer transfers.\n\n    Output:\n    - \"TRANSIT\" mode: Departure/arrival details, transit name/code, fare, details, warnings, alternative routes, and expected departure/arrival times.\n    - Other modes: Route description, distance, duration, warnings, alternative routes, tolls prices, and expected departure/arrival times.\n    \n    Current time in user's timezone: ${new Date().toLocaleString()}.\n    `;\n  }\n\n  async _call(\n    input: InferInteropZodOutput<typeof GoogleRoutesAPI.prototype.schema>\n  ) {\n    const {\n      origin,\n      destination,\n      travel_mode,\n      computeAlternativeRoutes,\n      departureTime,\n      arrivalTime,\n      transitPreferences,\n      extraComputations,\n    } = input;\n\n    const now = new Date();\n\n    if (departureTime && new Date(departureTime) < now) {\n      return \"It is not possible to calculate a route with a past departure time. Warn the user that it is not possible to calculate a route with a past departure time.\";\n    }\n\n    if (arrivalTime && new Date(arrivalTime) < now) {\n      return \"It is not possible to calculate a route with a past arrival time. Warn the user that it is not possible to calculate a route with a past arrival time.\";\n    }\n\n    if (travel_mode !== \"TRANSIT\" && arrivalTime) {\n      return \"It is not possible to calculate an arrival time for modes other than transit. Warn the user that it is not possible to calculate an arrival time for the selected mode of transport.\";\n    }\n\n    if (travel_mode === \"TRANSIT\" && extraComputations) {\n      return \"It is not possible to calculate tolls for transit mode. Warn the user that it is not possible to calculate tolls for transit mode.\";\n    }\n\n    const body: Body = {\n      origin: {\n        address: origin,\n      },\n      destination: {\n        address: destination,\n      },\n      travel_mode,\n      computeAlternativeRoutes: computeAlternativeRoutes ?? false,\n      departureTime,\n      arrivalTime,\n      transitPreferences,\n      extraComputations: (extraComputations as string[]) ?? [],\n    };\n\n    let fieldMask =\n      \"routes.description,routes.localizedValues,routes.travelAdvisory,routes.legs.steps.transitDetails,routes.routeLabels,routes.warnings\";\n\n    if (travel_mode === \"TRANSIT\") {\n      fieldMask += \",routes.legs.stepsOverview\";\n    }\n\n    if (travel_mode === \"DRIVE\" || travel_mode === \"TWO_WHEELER\") {\n      body.routing_preference = \"TRAFFIC_AWARE\";\n    }\n\n    const res = await fetch(\n      `https://routes.googleapis.com/directions/v2:computeRoutes`,\n      {\n        method: \"POST\",\n        body: JSON.stringify(body),\n        headers: {\n          \"X-Goog-Api-Key\": this.apiKey,\n          \"X-Goog-FieldMask\": fieldMask,\n          \"Content-Type\": \"application/json\",\n        },\n      }\n    );\n\n    if (!res.ok) {\n      let message;\n      try {\n        const json = await res.json();\n        message = json.error.message;\n      } catch (e) {\n        message = `Unable to parse error message: Google did not return a JSON response. Error: ${e}`;\n      }\n      throw new Error(\n        `Got ${res.status}: ${res.statusText} error from Google Routes API: ${message}`\n      );\n    }\n\n    const json = await res.json();\n\n    if (Object.keys(json).length === 0) {\n      return \"Invalid route. The route may be too long or impossible to travel by the selected mode of transport.\";\n    }\n\n    const routes: FilteredTransitRoute[] | FilteredRoute[] = json.routes.map(\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      (route: any) => filterRoutes(route, travel_mode)\n    );\n\n    return JSON.stringify(routes);\n  }\n}\n"],"mappings":"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"}