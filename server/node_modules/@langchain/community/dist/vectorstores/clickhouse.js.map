{"version":3,"file":"clickhouse.js","names":[],"sources":["../../src/vectorstores/clickhouse.ts"],"sourcesContent":["import * as uuid from \"uuid\";\nimport { ClickHouseClient, createClient } from \"@clickhouse/client\";\nimport { format } from \"mysql2\";\nimport type { EmbeddingsInterface } from \"@langchain/core/embeddings\";\nimport { VectorStore } from \"@langchain/core/vectorstores\";\nimport { Document } from \"@langchain/core/documents\";\n\n/**\n * Arguments for the ClickHouseStore class, which include the host, port,\n * protocol, username, password, index type, index parameters,\n * index query params, column map, database, table.\n */\nexport interface ClickHouseLibArgs {\n  host: string;\n  port: string | number;\n  protocol?: string;\n  username: string;\n  password: string;\n  indexType?: string;\n  indexParam?: string | Record<string, number>;\n  indexQueryParams?: Record<string, string>;\n  columnMap?: ColumnMap;\n  database?: string;\n  table?: string;\n}\n\n/**\n * Mapping of columns in the ClickHouse database.\n */\nexport interface ColumnMap {\n  id: string;\n  uuid: string;\n  document: string;\n  embedding: string;\n  metadata: string;\n}\n\n/**\n * Type for filtering search results in the ClickHouse database.\n */\nexport interface ClickHouseFilter {\n  whereStr: string;\n}\n\n/**\n * Class for interacting with the ClickHouse database. It extends the\n * VectorStore class and provides methods for adding vectors and\n * documents, searching for similar vectors, and creating instances from\n * texts or documents.\n */\nexport class ClickHouseStore extends VectorStore {\n  declare FilterType: ClickHouseFilter;\n\n  private client: ClickHouseClient;\n\n  private indexType: string;\n\n  private indexParam: string | Record<string, number>;\n\n  private indexQueryParams: Record<string, string>;\n\n  private columnMap: ColumnMap;\n\n  private database: string;\n\n  private table: string;\n\n  private isInitialized = false;\n\n  _vectorstoreType(): string {\n    return \"clickhouse\";\n  }\n\n  constructor(embeddings: EmbeddingsInterface, args: ClickHouseLibArgs) {\n    super(embeddings, args);\n\n    this.indexType = args.indexType || \"annoy\";\n    this.indexParam = args.indexParam || { L2Distance: 100 };\n    this.indexQueryParams = args.indexQueryParams || {};\n    this.columnMap = args.columnMap || {\n      id: \"id\",\n      document: \"document\",\n      embedding: \"embedding\",\n      metadata: \"metadata\",\n      uuid: \"uuid\",\n    };\n    this.database = args.database || \"default\";\n    this.table = args.table || \"vector_table\";\n\n    this.client = createClient({\n      host: `${args.protocol ?? \"https://\"}${args.host}:${args.port}`,\n      username: args.username,\n      password: args.password,\n      session_id: uuid.v4(),\n    });\n  }\n\n  /**\n   * Method to add vectors to the ClickHouse database.\n   * @param vectors The vectors to add.\n   * @param documents The documents associated with the vectors.\n   * @returns Promise that resolves when the vectors have been added.\n   */\n  async addVectors(vectors: number[][], documents: Document[]): Promise<void> {\n    if (vectors.length === 0) {\n      return;\n    }\n\n    if (!this.isInitialized) {\n      await this.initialize(vectors[0].length);\n    }\n\n    const queryStr = this.buildInsertQuery(vectors, documents);\n    await this.client.exec({ query: queryStr });\n  }\n\n  /**\n   * Method to add documents to the ClickHouse database.\n   * @param documents The documents to add.\n   * @returns Promise that resolves when the documents have been added.\n   */\n  async addDocuments(documents: Document[]): Promise<void> {\n    return this.addVectors(\n      await this.embeddings.embedDocuments(documents.map((d) => d.pageContent)),\n      documents\n    );\n  }\n\n  /**\n   * Method to search for vectors that are similar to a given query vector.\n   * @param query The query vector.\n   * @param k The number of similar vectors to return.\n   * @param filter Optional filter for the search results.\n   * @returns Promise that resolves with an array of tuples, each containing a Document and a score.\n   */\n  async similaritySearchVectorWithScore(\n    query: number[],\n    k: number,\n    filter?: this[\"FilterType\"]\n  ): Promise<[Document, number][]> {\n    if (!this.isInitialized) {\n      await this.initialize(query.length);\n    }\n    const queryStr = this.buildSearchQuery(query, k, filter);\n\n    const queryResultSet = await this.client.query({ query: queryStr });\n\n    const queryResult: {\n      data: { document: string; metadata: object; dist: number }[];\n    } = await queryResultSet.json();\n\n    const result: [Document, number][] = queryResult.data.map((item) => [\n      new Document({ pageContent: item.document, metadata: item.metadata }),\n      item.dist,\n    ]);\n\n    return result;\n  }\n\n  /**\n   * Static method to create an instance of ClickHouseStore from texts.\n   * @param texts The texts to use.\n   * @param metadatas The metadata associated with the texts.\n   * @param embeddings The embeddings to use.\n   * @param args The arguments for the ClickHouseStore.\n   * @returns Promise that resolves with a new instance of ClickHouseStore.\n   */\n  static async fromTexts(\n    texts: string[],\n    metadatas: object | object[],\n    embeddings: EmbeddingsInterface,\n    args: ClickHouseLibArgs\n  ): Promise<ClickHouseStore> {\n    const docs: Document[] = [];\n    for (let i = 0; i < texts.length; i += 1) {\n      const metadata = Array.isArray(metadatas) ? metadatas[i] : metadatas;\n      const newDoc = new Document({\n        pageContent: texts[i],\n        metadata,\n      });\n      docs.push(newDoc);\n    }\n    return ClickHouseStore.fromDocuments(docs, embeddings, args);\n  }\n\n  /**\n   * Static method to create an instance of ClickHouseStore from documents.\n   * @param docs The documents to use.\n   * @param embeddings The embeddings to use.\n   * @param args The arguments for the ClickHouseStore.\n   * @returns Promise that resolves with a new instance of ClickHouseStore.\n   */\n  static async fromDocuments(\n    docs: Document[],\n    embeddings: EmbeddingsInterface,\n    args: ClickHouseLibArgs\n  ): Promise<ClickHouseStore> {\n    const instance = new this(embeddings, args);\n    await instance.addDocuments(docs);\n    return instance;\n  }\n\n  /**\n   * Static method to create an instance of ClickHouseStore from an existing\n   * index.\n   * @param embeddings The embeddings to use.\n   * @param args The arguments for the ClickHouseStore.\n   * @returns Promise that resolves with a new instance of ClickHouseStore.\n   */\n  static async fromExistingIndex(\n    embeddings: EmbeddingsInterface,\n    args: ClickHouseLibArgs\n  ): Promise<ClickHouseStore> {\n    const instance = new this(embeddings, args);\n\n    await instance.initialize();\n    return instance;\n  }\n\n  /**\n   * Method to initialize the ClickHouse database.\n   * @param dimension Optional dimension of the vectors.\n   * @returns Promise that resolves when the database has been initialized.\n   */\n  private async initialize(dimension?: number): Promise<void> {\n    const dim = dimension ?? (await this.embeddings.embedQuery(\"test\")).length;\n\n    let indexParamStr = \"\";\n    if (this.indexParam) {\n      if (typeof this.indexParam === \"string\") {\n        indexParamStr = this.indexParam;\n      } else {\n        indexParamStr = Object.entries(this.indexParam)\n          .map(([key, value]) => `'${key}', ${value}`)\n          .join(\", \");\n      }\n    }\n\n    const query = `\n    CREATE TABLE IF NOT EXISTS ${this.database}.${this.table}(\n      ${this.columnMap.id} Nullable(String),\n      ${this.columnMap.document} Nullable(String),\n      ${this.columnMap.embedding} Array(Float32),\n      ${this.columnMap.metadata} JSON,\n      ${this.columnMap.uuid} UUID DEFAULT generateUUIDv4(),\n      CONSTRAINT cons_vec_len CHECK length(${this.columnMap.embedding}) = ${dim},\n      INDEX vec_idx ${this.columnMap.embedding} TYPE ${this.indexType}(${indexParamStr}) GRANULARITY 1000\n    ) ENGINE =  MergeTree ORDER BY ${this.columnMap.uuid} SETTINGS index_granularity = 8192;`;\n\n    await this.client.exec({\n      query,\n      clickhouse_settings: {\n        allow_experimental_object_type: 1,\n        allow_experimental_annoy_index: 1,\n      },\n    });\n    this.isInitialized = true;\n  }\n\n  /**\n   * Method to build an SQL query for inserting vectors and documents into\n   * the ClickHouse database.\n   * @param vectors The vectors to insert.\n   * @param documents The documents to insert.\n   * @returns The SQL query string.\n   */\n  private buildInsertQuery(vectors: number[][], documents: Document[]): string {\n    const columnsStr = Object.values(\n      Object.fromEntries(\n        Object.entries(this.columnMap).filter(\n          ([key]) => key !== this.columnMap.uuid\n        )\n      )\n    ).join(\", \");\n\n    const placeholders = vectors.map(() => \"(?, ?, ?, ?)\").join(\", \");\n    const values = [];\n\n    for (let i = 0; i < vectors.length; i += 1) {\n      const vector = vectors[i];\n      const document = documents[i];\n      values.push(\n        uuid.v4(),\n        this.escapeString(document.pageContent),\n        JSON.stringify(vector),\n        JSON.stringify(document.metadata)\n      );\n    }\n\n    const insertQueryStr = `\n      INSERT INTO TABLE ${this.database}.${this.table}(${columnsStr}) \n      VALUES ${placeholders}\n    `;\n\n    const insertQuery = format(insertQueryStr, values);\n    return insertQuery;\n  }\n\n  private escapeString(str: string): string {\n    return str.replace(/\\\\/g, \"\\\\\\\\\").replace(/'/g, \"\\\\'\");\n  }\n\n  /**\n   * Method to build an SQL query for searching for similar vectors in the\n   * ClickHouse database.\n   * @param query The query vector.\n   * @param k The number of similar vectors to return.\n   * @param filter Optional filter for the search results.\n   * @returns The SQL query string.\n   */\n  private buildSearchQuery(\n    query: number[],\n    k: number,\n    filter?: ClickHouseFilter\n  ): string {\n    const order = \"ASC\";\n    const whereStr = filter ? `PREWHERE ${filter.whereStr}` : \"\";\n    const placeholders = query.map(() => \"?\").join(\", \");\n\n    const settingStrings: string[] = [];\n    if (this.indexQueryParams) {\n      for (const [key, value] of Object.entries(this.indexQueryParams)) {\n        settingStrings.push(`SETTING ${key}=${value}`);\n      }\n    }\n\n    const searchQueryStr = `\n      SELECT ${this.columnMap.document} AS document, ${\n        this.columnMap.metadata\n      } AS metadata, dist\n      FROM ${this.database}.${this.table}\n      ${whereStr}\n      ORDER BY L2Distance(${\n        this.columnMap.embedding\n      }, [${placeholders}]) AS dist ${order}\n      LIMIT ${k} ${settingStrings.join(\" \")}\n    `;\n\n    // Format the query with actual values\n    const searchQuery = format(searchQueryStr, query);\n    return searchQuery;\n  }\n}\n"],"mappings":"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"}