{"version":3,"file":"turbopuffer.js","names":["uuidv4"],"sources":["../../src/vectorstores/turbopuffer.ts"],"sourcesContent":["import { v4 as uuidv4 } from \"uuid\";\nimport { type DocumentInterface, Document } from \"@langchain/core/documents\";\nimport type { EmbeddingsInterface } from \"@langchain/core/embeddings\";\nimport {\n  AsyncCaller,\n  AsyncCallerParams,\n} from \"@langchain/core/utils/async_caller\";\nimport { chunkArray } from \"@langchain/core/utils/chunk_array\";\nimport { getEnvironmentVariable } from \"@langchain/core/utils/env\";\nimport { VectorStore } from \"@langchain/core/vectorstores\";\n\n/**\n * @deprecated Use `TurbopufferDistanceMetric` from `@langchain/turbopuffer` instead.\n */\nexport type TurbopufferDistanceMetric = \"cosine_distance\" | \"euclidean_squared\";\n\n/**\n * @deprecated Use `TurbopufferFilter` from `@langchain/turbopuffer` instead.\n */\nexport type TurbopufferFilterType = Record<\n  string,\n  Array<[string, string[] | string]>\n>;\n\n/**\n * @deprecated Use `TurbopufferParams` from `@langchain/turbopuffer` instead.\n */\nexport interface TurbopufferParams extends AsyncCallerParams {\n  apiKey?: string;\n  namespace?: string;\n  distanceMetric?: TurbopufferDistanceMetric;\n  apiUrl?: string;\n  batchSize?: number;\n}\n\n/**\n * @deprecated Use `@langchain/turbopuffer` instead.\n */\nexport interface TurbopufferQueryResult {\n  dist: number;\n  id: number;\n  vector?: number[];\n  attributes: Record<string, string>;\n}\n\n/**\n * @deprecated Use `TurbopufferVectorStore` from `@langchain/turbopuffer` instead.\n * The new package uses the official SDK and supports document deletion, region\n * configuration, and returns document IDs in search results.\n */\nexport class TurbopufferVectorStore extends VectorStore {\n  declare FilterType: TurbopufferFilterType;\n\n  get lc_secrets(): { [key: string]: string } {\n    return {\n      apiKey: \"TURBOPUFFER_API_KEY\",\n    };\n  }\n\n  get lc_aliases(): { [key: string]: string } {\n    return {\n      apiKey: \"TURBOPUFFER_API_KEY\",\n    };\n  }\n\n  // Handle minification for tracing\n  static lc_name(): string {\n    return \"TurbopufferVectorStore\";\n  }\n\n  protected distanceMetric: TurbopufferDistanceMetric = \"cosine_distance\";\n\n  protected apiKey: string;\n\n  protected namespace = \"default\";\n\n  protected apiUrl = \"https://api.turbopuffer.com/v1\";\n\n  caller: AsyncCaller;\n\n  batchSize = 3000;\n\n  public _vectorstoreType(): string {\n    return \"turbopuffer\";\n  }\n\n  constructor(embeddings: EmbeddingsInterface, args: TurbopufferParams) {\n    super(embeddings, args);\n\n    const {\n      apiKey: argsApiKey,\n      namespace,\n      distanceMetric,\n      apiUrl,\n      batchSize,\n      ...asyncCallerArgs\n    } = args;\n\n    const apiKey = argsApiKey ?? getEnvironmentVariable(\"TURBOPUFFER_API_KEY\");\n    if (!apiKey) {\n      throw new Error(\n        `Turbopuffer API key not found.\\nPlease pass it in as \"apiKey\" or set it as an environment variable called \"TURBOPUFFER_API_KEY\"`\n      );\n    }\n    this.apiKey = apiKey;\n    this.namespace = namespace ?? this.namespace;\n    this.distanceMetric = distanceMetric ?? this.distanceMetric;\n    this.apiUrl = apiUrl ?? this.apiUrl;\n    this.batchSize = batchSize ?? this.batchSize;\n    this.caller = new AsyncCaller({\n      maxConcurrency: 6,\n      maxRetries: 0,\n      ...asyncCallerArgs,\n    });\n  }\n\n  defaultHeaders() {\n    return {\n      Authorization: `Bearer ${this.apiKey}`,\n      \"Content-Type\": \"application/json\",\n    };\n  }\n\n  async callWithRetry(\n    fetchUrl: string,\n    stringifiedBody: string | undefined,\n    method = \"POST\"\n  ) {\n    const json = await this.caller.call(async () => {\n      const headers: Record<string, string> = {\n        Authorization: `Bearer ${this.apiKey}`,\n      };\n      if (stringifiedBody !== undefined) {\n        headers[\"Content-Type\"] = \"application/json\";\n      }\n      const response = await fetch(fetchUrl, {\n        method,\n        headers,\n        body: stringifiedBody,\n      });\n      if (response.status !== 200) {\n        const error = new Error(\n          `Failed to call turbopuffer. Response status ${\n            response.status\n          }\\nFull response: ${await response.text()}`\n        );\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        (error as any).response = response;\n        throw error;\n      }\n      return response.json();\n    });\n\n    return json;\n  }\n\n  async addVectors(\n    vectors: number[][],\n    documents: DocumentInterface[],\n    options?: { ids?: string[] }\n  ): Promise<string[]> {\n    if (options?.ids && options.ids.length !== vectors.length) {\n      throw new Error(\n        \"Number of ids provided does not match number of vectors\"\n      );\n    }\n\n    if (documents.length !== vectors.length) {\n      throw new Error(\n        \"Number of documents provided does not match number of vectors\"\n      );\n    }\n\n    if (documents.length === 0) {\n      throw new Error(\"No documents provided\");\n    }\n\n    const batchedVectors: number[][][] = chunkArray(vectors, this.batchSize);\n    const batchedDocuments: DocumentInterface[][] = chunkArray(\n      documents,\n      this.batchSize\n    );\n    const batchedIds = options?.ids\n      ? chunkArray(options.ids, this.batchSize)\n      : batchedDocuments.map((docs) => docs.map((_) => uuidv4()));\n\n    const batchRequests = batchedVectors.map(async (batchVectors, index) => {\n      const batchDocs = batchedDocuments[index];\n      const batchIds = batchedIds[index];\n\n      if (batchIds.length !== batchVectors.length) {\n        throw new Error(\n          \"Number of ids provided does not match number of vectors\"\n        );\n      }\n\n      const attributes: Record<string, (string | null)[]> = {\n        __lc_page_content: batchDocs.map((doc) => doc.pageContent),\n      };\n\n      const usedMetadataFields = new Set(\n        batchDocs.map((doc) => Object.keys(doc.metadata)).flat()\n      );\n\n      for (const key of usedMetadataFields) {\n        attributes[key] = batchDocs.map((doc) => {\n          if (doc.metadata[key] !== undefined) {\n            if (typeof doc.metadata[key] === \"string\") {\n              return doc.metadata[key];\n            } else {\n              console.warn(\n                [\n                  `[WARNING]: Dropping non-string metadata key \"${key}\" with value \"${JSON.stringify(\n                    doc.metadata[key]\n                  )}\".`,\n                  `turbopuffer currently supports only string metadata values.`,\n                ].join(\"\\n\")\n              );\n              return null;\n            }\n          } else {\n            return null;\n          }\n        });\n      }\n\n      const data = {\n        ids: batchIds,\n        vectors: batchVectors,\n        distance_metric: this.distanceMetric,\n        attributes,\n      };\n\n      return this.callWithRetry(\n        `${this.apiUrl}/vectors/${this.namespace}`,\n        JSON.stringify(data)\n      );\n    });\n\n    // Execute all batch requests in parallel\n    await Promise.all(batchRequests);\n    return batchedIds.flat();\n  }\n\n  async delete(params: { deleteIndex?: boolean }): Promise<void> {\n    if (params.deleteIndex) {\n      await this.callWithRetry(\n        `${this.apiUrl}/vectors/${this.namespace}`,\n        undefined,\n        \"DELETE\"\n      );\n    } else {\n      throw new Error(`You must provide a \"deleteIndex\" flag.`);\n    }\n  }\n\n  async addDocuments(\n    documents: DocumentInterface[],\n    options?: { ids?: string[] }\n  ): Promise<string[]> {\n    const vectors = await this.embeddings.embedDocuments(\n      documents.map((doc) => doc.pageContent)\n    );\n\n    return this.addVectors(vectors, documents, options);\n  }\n\n  protected async queryVectors(\n    query: number[],\n    k: number,\n    includeVector?: boolean,\n    // See https://Turbopuffer.com/docs/reference/query for more info\n    filter?: this[\"FilterType\"]\n  ): Promise<TurbopufferQueryResult[]> {\n    const data = {\n      vector: query,\n      top_k: k,\n      distance_metric: this.distanceMetric,\n      filters: filter,\n      include_attributes: true,\n      include_vectors: includeVector,\n    };\n\n    return this.callWithRetry(\n      `${this.apiUrl}/vectors/${this.namespace}/query`,\n      JSON.stringify(data)\n    );\n  }\n\n  async similaritySearchVectorWithScore(\n    query: number[],\n    k: number,\n    filter?: this[\"FilterType\"]\n  ): Promise<[DocumentInterface, number][]> {\n    const search = await this.queryVectors(query, k, false, filter);\n    const result: [DocumentInterface, number][] = search.map((res) => {\n      const { __lc_page_content, ...metadata } = res.attributes;\n      return [\n        new Document({\n          pageContent: __lc_page_content,\n          metadata,\n        }),\n        res.dist,\n      ];\n    });\n\n    return result;\n  }\n\n  static async fromDocuments(\n    docs: DocumentInterface[],\n    embeddings: EmbeddingsInterface,\n    dbConfig: TurbopufferParams\n  ): Promise<TurbopufferVectorStore> {\n    const instance = new this(embeddings, dbConfig);\n    await instance.addDocuments(docs);\n    return instance;\n  }\n}\n"],"mappings":"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"}