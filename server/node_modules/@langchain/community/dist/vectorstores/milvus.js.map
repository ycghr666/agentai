{"version":3,"file":"milvus.js","names":[],"sources":["../../src/vectorstores/milvus.ts"],"sourcesContent":["import * as uuid from \"uuid\";\nimport {\n  MilvusClient,\n  DataType,\n  DataTypeMap,\n  ErrorCode,\n  FieldType,\n  ClientConfig,\n  InsertReq,\n  keyValueObj,\n} from \"@zilliz/milvus2-sdk-node\";\n\nimport type { EmbeddingsInterface } from \"@langchain/core/embeddings\";\nimport { VectorStore } from \"@langchain/core/vectorstores\";\nimport { Document } from \"@langchain/core/documents\";\nimport { getEnvironmentVariable } from \"@langchain/core/utils/env\";\n\n/**\n * Interface for the arguments required by the Milvus class constructor.\n */\nexport interface MilvusLibArgs {\n  collectionName?: string;\n  partitionName?: string;\n  primaryField?: string;\n  vectorField?: string;\n  textField?: string;\n  url?: string; // db address\n  ssl?: boolean;\n  username?: string;\n  password?: string;\n  textFieldMaxLength?: number;\n  clientConfig?: ClientConfig;\n  autoId?: boolean;\n  indexCreateOptions?: IndexCreateOptions;\n  partitionKey?: string; // doc: https://milvus.io/docs/use-partition-key.md\n  partitionKeyMaxLength?: number;\n}\n\nexport interface IndexCreateOptions {\n  index_type: IndexType;\n  metric_type: MetricType;\n  params?: keyValueObj;\n  // index search params\n  search_params?: keyValueObj;\n}\n\nexport type MetricType = \"L2\" | \"IP\" | \"COSINE\";\n\n/**\n * Type representing the type of index used in the Milvus database.\n */\ntype IndexType =\n  | \"FLAT\"\n  | \"IVF_FLAT\"\n  | \"IVF_SQ8\"\n  | \"IVF_PQ\"\n  | \"HNSW\"\n  | \"RHNSW_FLAT\"\n  | \"RHNSW_SQ\"\n  | \"RHNSW_PQ\"\n  | \"IVF_HNSW\"\n  | \"ANNOY\";\n\n/**\n * Interface for vector search parameters.\n */\ninterface IndexSearchParam {\n  params: { nprobe?: number; ef?: number; search_k?: number };\n}\n\ninterface InsertRow {\n  [x: string]: string | number[];\n}\n\nconst MILVUS_PRIMARY_FIELD_NAME = \"langchain_primaryid\";\nconst MILVUS_VECTOR_FIELD_NAME = \"langchain_vector\";\nconst MILVUS_TEXT_FIELD_NAME = \"langchain_text\";\nconst MILVUS_COLLECTION_NAME_PREFIX = \"langchain_col\";\nconst MILVUS_PARTITION_KEY_MAX_LENGTH = 512;\n\n/**\n * Default parameters for index searching.\n */\nconst DEFAULT_INDEX_SEARCH_PARAMS: Record<IndexType, IndexSearchParam> = {\n  FLAT: { params: {} },\n  IVF_FLAT: { params: { nprobe: 10 } },\n  IVF_SQ8: { params: { nprobe: 10 } },\n  IVF_PQ: { params: { nprobe: 10 } },\n  HNSW: { params: { ef: 10 } },\n  RHNSW_FLAT: { params: { ef: 10 } },\n  RHNSW_SQ: { params: { ef: 10 } },\n  RHNSW_PQ: { params: { ef: 10 } },\n  IVF_HNSW: { params: { nprobe: 10, ef: 10 } },\n  ANNOY: { params: { search_k: 10 } },\n};\n\n/**\n * Class for interacting with a Milvus database. Extends the VectorStore\n * class.\n */\nexport class Milvus extends VectorStore {\n  get lc_secrets(): { [key: string]: string } {\n    return {\n      ssl: \"MILVUS_SSL\",\n      username: \"MILVUS_USERNAME\",\n      password: \"MILVUS_PASSWORD\",\n    };\n  }\n\n  _vectorstoreType(): string {\n    return \"milvus\";\n  }\n\n  declare FilterType: string;\n\n  collectionName: string;\n\n  partitionName?: string;\n\n  numDimensions?: number;\n\n  autoId?: boolean;\n\n  primaryField: string;\n\n  vectorField: string;\n\n  textField: string;\n\n  textFieldMaxLength: number;\n\n  partitionKey?: string;\n\n  partitionKeyMaxLength?: number;\n\n  fields: string[];\n\n  client: MilvusClient;\n\n  indexCreateParams: IndexCreateOptions;\n\n  indexSearchParams: keyValueObj;\n\n  constructor(\n    public embeddings: EmbeddingsInterface,\n    args: MilvusLibArgs\n  ) {\n    super(embeddings, args);\n    this.collectionName = args.collectionName ?? genCollectionName();\n    this.partitionName = args.partitionName;\n    this.textField = args.textField ?? MILVUS_TEXT_FIELD_NAME;\n\n    this.autoId = args.autoId ?? true;\n    this.primaryField = args.primaryField ?? MILVUS_PRIMARY_FIELD_NAME;\n    this.vectorField = args.vectorField ?? MILVUS_VECTOR_FIELD_NAME;\n\n    this.textFieldMaxLength = args.textFieldMaxLength ?? 0;\n\n    this.partitionKey = args.partitionKey;\n    this.partitionKeyMaxLength =\n      args.partitionKeyMaxLength ?? MILVUS_PARTITION_KEY_MAX_LENGTH;\n\n    this.fields = [];\n\n    const url = args.url ?? getEnvironmentVariable(\"MILVUS_URL\");\n    const {\n      address = \"\",\n      username = \"\",\n      password = \"\",\n      ssl,\n    } = args.clientConfig || {};\n\n    // Index creation parameters\n    const { indexCreateOptions } = args;\n    if (indexCreateOptions) {\n      const {\n        metric_type,\n        index_type,\n        params,\n        search_params = {},\n      } = indexCreateOptions;\n      this.indexCreateParams = {\n        metric_type,\n        index_type,\n        params,\n      };\n      this.indexSearchParams = {\n        ...DEFAULT_INDEX_SEARCH_PARAMS[index_type].params,\n        ...search_params,\n      };\n    } else {\n      // Default index creation parameters.\n      this.indexCreateParams = {\n        index_type: \"HNSW\",\n        metric_type: \"L2\",\n        params: { M: 8, efConstruction: 64 },\n      };\n      // Default index search parameters.\n      this.indexSearchParams = {\n        ...DEFAULT_INDEX_SEARCH_PARAMS.HNSW.params,\n      };\n    }\n\n    // combine args clientConfig and env variables\n    const clientConfig: ClientConfig = {\n      ...(args.clientConfig || {}),\n      address: url || address,\n      username: args.username || username,\n      password: args.password || password,\n      ssl: args.ssl || ssl,\n    };\n\n    if (!clientConfig.address) {\n      throw new Error(\"Milvus URL address is not provided.\");\n    }\n    this.client = new MilvusClient(clientConfig);\n  }\n\n  /**\n   * Adds documents to the Milvus database.\n   * @param documents Array of Document instances to be added to the database.\n   * @param options Optional parameter that can include specific IDs for the documents.\n   * @returns Promise resolving to void.\n   */\n  async addDocuments(\n    documents: Document[],\n    options?: { ids?: string[] }\n  ): Promise<void> {\n    const texts = documents.map(({ pageContent }) => pageContent);\n    await this.addVectors(\n      await this.embeddings.embedDocuments(texts),\n      documents,\n      options\n    );\n  }\n\n  /**\n   * Adds vectors to the Milvus database.\n   * @param vectors Array of vectors to be added to the database.\n   * @param documents Array of Document instances associated with the vectors.\n   * @param options Optional parameter that can include specific IDs for the documents.\n   * @returns Promise resolving to void.\n   */\n  async addVectors(\n    vectors: number[][],\n    documents: Document[],\n    options?: { ids?: string[] }\n  ): Promise<void> {\n    if (vectors.length === 0) {\n      return;\n    }\n    await this.ensureCollection(vectors, documents);\n    if (this.partitionName !== undefined) {\n      await this.ensurePartition();\n    }\n\n    const documentIds = options?.ids ?? [];\n\n    const insertDatas: InsertRow[] = [];\n    for (let index = 0; index < vectors.length; index++) {\n      const vec = vectors[index];\n      const doc = documents[index];\n      const data: InsertRow = {\n        [this.textField]: doc.pageContent,\n        [this.vectorField]: vec,\n      };\n      this.fields.forEach((field) => {\n        switch (field) {\n          case this.primaryField:\n            if (documentIds[index] !== undefined) {\n              data[field] = documentIds[index];\n            } else if (!this.autoId) {\n              if (doc.metadata[this.primaryField] === undefined) {\n                throw new Error(\n                  `The Collection's primaryField is configured with autoId=false, thus its value must be provided through metadata.`\n                );\n              }\n              data[field] = doc.metadata[this.primaryField];\n            }\n            break;\n          case this.textField:\n            data[field] = doc.pageContent;\n            break;\n          case this.vectorField:\n            data[field] = vec;\n            break;\n          default: // metadata fields\n            if (doc.metadata[field] === undefined) {\n              throw new Error(\n                `The field \"${field}\" is not provided in documents[${index}].metadata.`\n              );\n            } else if (typeof doc.metadata[field] === \"object\") {\n              data[field] = JSON.stringify(doc.metadata[field]);\n            } else {\n              data[field] = doc.metadata[field];\n            }\n            break;\n        }\n      });\n\n      insertDatas.push(data);\n    }\n\n    const params: InsertReq = {\n      collection_name: this.collectionName,\n      fields_data: insertDatas,\n    };\n    if (this.partitionName !== undefined) {\n      params.partition_name = this.partitionName;\n    }\n    const insertResp = this.autoId\n      ? await this.client.insert(params)\n      : await this.client.upsert(params);\n\n    if (insertResp.status.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(\n        `Error ${\n          this.autoId ? \"inserting\" : \"upserting\"\n        } data: ${JSON.stringify(insertResp)}`\n      );\n    }\n    await this.client.flushSync({ collection_names: [this.collectionName] });\n  }\n\n  /**\n   * Searches for vectors in the Milvus database that are similar to a given\n   * vector.\n   * @param query Vector to compare with the vectors in the database.\n   * @param k Number of similar vectors to return.\n   * @param filter Optional filter to apply to the search.\n   * @returns Promise resolving to an array of tuples, each containing a Document instance and a similarity score.\n   */\n  async similaritySearchVectorWithScore(\n    query: number[],\n    k: number,\n    filter?: string\n  ): Promise<[Document, number][]> {\n    const hasColResp = await this.client.hasCollection({\n      collection_name: this.collectionName,\n    });\n    if (hasColResp.status.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(`Error checking collection: ${hasColResp}`);\n    }\n    if (hasColResp.value === false) {\n      throw new Error(\n        `Collection not found: ${this.collectionName}, please create collection before search.`\n      );\n    }\n\n    const filterStr = filter ?? \"\";\n\n    await this.grabCollectionFields();\n\n    const loadResp = await this.client.loadCollectionSync({\n      collection_name: this.collectionName,\n    });\n    if (loadResp.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(`Error loading collection: ${loadResp}`);\n    }\n\n    // clone this.field and remove vectorField\n    const outputFields = this.fields.filter(\n      (field) => field !== this.vectorField\n    );\n\n    const searchResp = await this.client.search({\n      collection_name: this.collectionName,\n      search_params: {\n        anns_field: this.vectorField,\n        topk: k,\n        metric_type: this.indexCreateParams.metric_type,\n        params: JSON.stringify(this.indexSearchParams),\n      },\n      output_fields: outputFields,\n      vector_type: DataType.FloatVector,\n      vectors: [query],\n      filter: filterStr,\n    });\n    if (searchResp.status.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(`Error searching data: ${JSON.stringify(searchResp)}`);\n    }\n    const results: [Document, number][] = [];\n    searchResp.results.forEach((result) => {\n      const fields = {\n        pageContent: \"\",\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        metadata: {} as Record<string, any>,\n      };\n      Object.keys(result).forEach((key) => {\n        if (key === this.textField) {\n          fields.pageContent = result[key];\n        } else if (this.fields.includes(key) || key === this.primaryField) {\n          if (typeof result[key] === \"string\") {\n            const { isJson, obj } = checkJsonString(result[key]);\n            fields.metadata[key] = isJson ? obj : result[key];\n          } else {\n            fields.metadata[key] = result[key];\n          }\n        }\n      });\n      results.push([new Document(fields), result.score]);\n    });\n    // console.log(\"Search result: \" + JSON.stringify(results, null, 2));\n    return results;\n  }\n\n  /**\n   * Ensures that a collection exists in the Milvus database.\n   * @param vectors Optional array of vectors to be used if a new collection needs to be created.\n   * @param documents Optional array of Document instances to be used if a new collection needs to be created.\n   * @returns Promise resolving to void.\n   */\n  async ensureCollection(vectors?: number[][], documents?: Document[]) {\n    const hasColResp = await this.client.hasCollection({\n      collection_name: this.collectionName,\n    });\n    if (hasColResp.status.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(\n        `Error checking collection: ${JSON.stringify(hasColResp, null, 2)}`\n      );\n    }\n\n    if (hasColResp.value === false) {\n      if (vectors === undefined || documents === undefined) {\n        throw new Error(\n          `Collection not found: ${this.collectionName}, please provide vectors and documents to create collection.`\n        );\n      }\n      await this.createCollection(vectors, documents);\n    } else {\n      await this.grabCollectionFields();\n    }\n  }\n\n  /**\n   * Ensures that a partition exists in the Milvus collection.\n   * @returns Promise resolving to void.\n   */\n  async ensurePartition() {\n    if (this.partitionName === undefined) {\n      return;\n    }\n    const hasPartResp = await this.client.hasPartition({\n      collection_name: this.collectionName,\n      partition_name: this.partitionName,\n    });\n    if (hasPartResp.status.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(\n        `Error checking partition: ${JSON.stringify(hasPartResp, null, 2)}`\n      );\n    }\n\n    if (hasPartResp.value === false) {\n      await this.client.createPartition({\n        collection_name: this.collectionName,\n        partition_name: this.partitionName,\n      });\n    }\n  }\n\n  /**\n   * Creates a collection in the Milvus database.\n   * @param vectors Array of vectors to be added to the new collection.\n   * @param documents Array of Document instances to be added to the new collection.\n   * @returns Promise resolving to void.\n   */\n  async createCollection(\n    vectors: number[][],\n    documents: Document[]\n  ): Promise<void> {\n    const fieldList: FieldType[] = [];\n\n    fieldList.push(\n      ...createFieldTypeForMetadata(\n        documents,\n        this.primaryField,\n        this.partitionKey\n      )\n    );\n\n    if (this.autoId) {\n      fieldList.push({\n        name: this.primaryField,\n        description: \"Primary key\",\n        data_type: DataType.Int64,\n        is_primary_key: true,\n        autoID: true,\n      });\n    } else {\n      fieldList.push({\n        name: this.primaryField,\n        description: \"Primary key\",\n        data_type: DataType.VarChar,\n        is_primary_key: true,\n        autoID: false,\n        max_length: 65535,\n      });\n    }\n\n    fieldList.push(\n      {\n        name: this.textField,\n        description: \"Text field\",\n        data_type: DataType.VarChar,\n        type_params: {\n          max_length:\n            this.textFieldMaxLength > 0\n              ? this.textFieldMaxLength.toString()\n              : getTextFieldMaxLength(documents).toString(),\n        },\n      },\n      {\n        name: this.vectorField,\n        description: \"Vector field\",\n        data_type: DataType.FloatVector,\n        type_params: {\n          dim: getVectorFieldDim(vectors).toString(),\n        },\n      }\n    );\n\n    if (this.partitionKey) {\n      fieldList.push({\n        name: this.partitionKey,\n        description: \"Partition key\",\n        data_type: DataType.VarChar,\n        max_length: this.partitionKeyMaxLength,\n        is_partition_key: true,\n      });\n    }\n\n    fieldList.forEach((field) => {\n      if (!field.autoID) {\n        this.fields.push(field.name);\n      }\n    });\n\n    const createRes = await this.client.createCollection({\n      collection_name: this.collectionName,\n      fields: fieldList,\n    });\n\n    if (createRes.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(`Failed to create collection: ${createRes}`);\n    }\n\n    const extraParams = {\n      ...this.indexCreateParams,\n      params: JSON.stringify(this.indexCreateParams.params),\n    };\n    await this.client.createIndex({\n      collection_name: this.collectionName,\n      field_name: this.vectorField,\n      extra_params: extraParams,\n    });\n  }\n\n  /**\n   * Retrieves the fields of a collection in the Milvus database.\n   * @returns Promise resolving to void.\n   */\n  async grabCollectionFields(): Promise<void> {\n    if (!this.collectionName) {\n      throw new Error(\"Need collection name to grab collection fields\");\n    }\n    if (\n      this.primaryField &&\n      this.vectorField &&\n      this.textField &&\n      this.fields.length > 0\n    ) {\n      return;\n    }\n    const desc = await this.client.describeCollection({\n      collection_name: this.collectionName,\n    });\n    desc.schema.fields.forEach((field) => {\n      this.fields.push(field.name);\n      // Remove autoID fields from this.fields if we're using autoId mode\n      // When autoId is false, we need to include the primary field for upsert operations\n      if (field.autoID && this.autoId) {\n        const index = this.fields.indexOf(field.name);\n        if (index !== -1) {\n          this.fields.splice(index, 1);\n        }\n      }\n      // Remove isFunctionOutput fields from this.fields if this field is calculated on server side\n      // When isFunctionOutput is false, we need to include this field for upsert operations\n      if (field.is_function_output) {\n        const index = this.fields.indexOf(field.name);\n        if (index !== -1) {\n          this.fields.splice(index, 1);\n        }\n      }\n      if (field.is_primary_key) {\n        this.primaryField = field.name;\n      }\n      const dtype = DataTypeMap[field.data_type];\n      if (dtype === DataType.FloatVector || dtype === DataType.BinaryVector) {\n        this.vectorField = field.name;\n      }\n\n      if (dtype === DataType.VarChar && field.name === MILVUS_TEXT_FIELD_NAME) {\n        this.textField = field.name;\n      }\n    });\n  }\n\n  /**\n   * Creates a Milvus instance from a set of texts and their associated\n   * metadata.\n   * @param texts Array of texts to be added to the database.\n   * @param metadatas Array of metadata objects associated with the texts.\n   * @param embeddings Embeddings instance used to generate vector embeddings for the texts.\n   * @param dbConfig Optional configuration for the Milvus database.\n   * @returns Promise resolving to a new Milvus instance.\n   */\n  static async fromTexts(\n    texts: string[],\n    metadatas: object[] | object,\n    embeddings: EmbeddingsInterface,\n    dbConfig?: MilvusLibArgs\n  ): Promise<Milvus> {\n    const docs: Document[] = [];\n    for (let i = 0; i < texts.length; i += 1) {\n      const metadata = Array.isArray(metadatas) ? metadatas[i] : metadatas;\n      const newDoc = new Document({\n        pageContent: texts[i],\n        metadata,\n      });\n      docs.push(newDoc);\n    }\n    return Milvus.fromDocuments(docs, embeddings, dbConfig);\n  }\n\n  /**\n   * Creates a Milvus instance from a set of Document instances.\n   * @param docs Array of Document instances to be added to the database.\n   * @param embeddings Embeddings instance used to generate vector embeddings for the documents.\n   * @param dbConfig Optional configuration for the Milvus database.\n   * @returns Promise resolving to a new Milvus instance.\n   */\n  static async fromDocuments(\n    docs: Document[],\n    embeddings: EmbeddingsInterface,\n    dbConfig?: MilvusLibArgs\n  ): Promise<Milvus> {\n    const args: MilvusLibArgs = {\n      ...dbConfig,\n      collectionName: dbConfig?.collectionName ?? genCollectionName(),\n    };\n    const instance = new this(embeddings, args);\n    await instance.addDocuments(docs);\n    return instance;\n  }\n\n  /**\n   * Creates a Milvus instance from an existing collection in the Milvus\n   * database.\n   * @param embeddings Embeddings instance used to generate vector embeddings for the documents in the collection.\n   * @param dbConfig Configuration for the Milvus database.\n   * @returns Promise resolving to a new Milvus instance.\n   */\n  static async fromExistingCollection(\n    embeddings: EmbeddingsInterface,\n    dbConfig: MilvusLibArgs\n  ): Promise<Milvus> {\n    const instance = new this(embeddings, dbConfig);\n    await instance.ensureCollection();\n    return instance;\n  }\n\n  /**\n   * Deletes data from the Milvus database.\n   * @param params Object containing a filter to apply to the deletion.\n   * @returns Promise resolving to void.\n   */\n  async delete(params: { filter?: string; ids?: string[] }): Promise<void> {\n    const hasColResp = await this.client.hasCollection({\n      collection_name: this.collectionName,\n    });\n    if (hasColResp.status.error_code !== ErrorCode.SUCCESS) {\n      throw new Error(`Error checking collection: ${hasColResp}`);\n    }\n    if (hasColResp.value === false) {\n      throw new Error(\n        `Collection not found: ${this.collectionName}, please create collection before search.`\n      );\n    }\n\n    const { filter, ids } = params;\n\n    if (filter && !ids) {\n      const deleteResp = await this.client.deleteEntities({\n        collection_name: this.collectionName,\n        expr: filter,\n      });\n\n      if (deleteResp.status.error_code !== ErrorCode.SUCCESS) {\n        throw new Error(`Error deleting data: ${JSON.stringify(deleteResp)}`);\n      }\n    } else if (!filter && ids && ids.length > 0) {\n      const deleteResp = await this.client.delete({\n        collection_name: this.collectionName,\n        ids,\n      });\n\n      if (deleteResp.status.error_code !== ErrorCode.SUCCESS) {\n        throw new Error(\n          `Error deleting data with ids: ${JSON.stringify(deleteResp)}`\n        );\n      }\n    }\n  }\n}\n\nfunction createFieldTypeForMetadata(\n  documents: Document[],\n  primaryFieldName: string,\n  partitionKey?: string\n): FieldType[] {\n  const sampleMetadata = documents[0].metadata;\n  let textFieldMaxLength = 0;\n  let jsonFieldMaxLength = 0;\n  const textEncoder = new TextEncoder();\n  documents.forEach(({ metadata }) => {\n    // check all keys name and count in metadata is same as sampleMetadata\n    Object.keys(metadata).forEach((key) => {\n      if (\n        !(key in metadata) ||\n        typeof metadata[key] !== typeof sampleMetadata[key]\n      ) {\n        throw new Error(\n          \"All documents must have same metadata keys and datatype\"\n        );\n      }\n\n      // find max length of string field and json field, cache json string value\n      if (typeof metadata[key] === \"string\") {\n        const textLengthInBytes = textEncoder.encode(metadata[key]).length;\n        if (textLengthInBytes > textFieldMaxLength) {\n          textFieldMaxLength = textLengthInBytes;\n        }\n      } else if (typeof metadata[key] === \"object\") {\n        const json = JSON.stringify(metadata[key]);\n        const jsonLengthInBytes = textEncoder.encode(json).length;\n        if (jsonLengthInBytes > jsonFieldMaxLength) {\n          jsonFieldMaxLength = jsonLengthInBytes;\n        }\n      }\n    });\n  });\n\n  const fields: FieldType[] = [];\n  for (const [key, value] of Object.entries(sampleMetadata)) {\n    const type = typeof value;\n\n    if (key === primaryFieldName || key === partitionKey) {\n      /**\n       * skip primary field and partition key\n       * because we will create primary field and partition key in createCollection\n       *  */\n    } else if (type === \"string\") {\n      fields.push({\n        name: key,\n        description: `Metadata String field`,\n        data_type: DataType.VarChar,\n        type_params: {\n          max_length: textFieldMaxLength.toString(),\n        },\n      });\n    } else if (type === \"number\") {\n      fields.push({\n        name: key,\n        description: `Metadata Number field`,\n        data_type: DataType.Float,\n      });\n    } else if (type === \"boolean\") {\n      fields.push({\n        name: key,\n        description: `Metadata Boolean field`,\n        data_type: DataType.Bool,\n      });\n    } else if (value === null) {\n      // skip\n    } else {\n      // use json for other types\n      try {\n        fields.push({\n          name: key,\n          description: `Metadata JSON field`,\n          data_type: DataType.VarChar,\n          type_params: {\n            max_length: jsonFieldMaxLength.toString(),\n          },\n        });\n      } catch {\n        throw new Error(\"Failed to parse metadata field as JSON\");\n      }\n    }\n  }\n  return fields;\n}\n\nfunction genCollectionName(): string {\n  return `${MILVUS_COLLECTION_NAME_PREFIX}_${uuid.v4().replaceAll(\"-\", \"\")}`;\n}\n\nfunction getTextFieldMaxLength(documents: Document[]) {\n  let textMaxLength = 0;\n  const textEncoder = new TextEncoder();\n  for (let i = 0; i < documents.length; i++) {\n    const text = documents[i].pageContent;\n    const textLengthInBytes = textEncoder.encode(text).length;\n    if (textLengthInBytes > textMaxLength) {\n      textMaxLength = textLengthInBytes;\n    }\n  }\n  return textMaxLength;\n}\n\nfunction getVectorFieldDim(vectors: number[][]) {\n  if (vectors.length === 0) {\n    throw new Error(\"No vectors found\");\n  }\n  return vectors[0].length;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction checkJsonString(value: string): { isJson: boolean; obj: any } {\n  try {\n    const result = JSON.parse(value);\n    return { isJson: true, obj: result };\n  } catch {\n    return { isJson: false, obj: null };\n  }\n}\n"],"mappings":"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"}