{"version":3,"file":"singlestore.js","names":[],"sources":["../../src/vectorstores/singlestore.ts"],"sourcesContent":["import type {\n  Pool,\n  RowDataPacket,\n  OkPacket,\n  ResultSetHeader,\n  FieldPacket,\n  PoolOptions,\n} from \"mysql2/promise\";\nimport { format } from \"mysql2\";\nimport { createPool } from \"mysql2/promise\";\nimport type { EmbeddingsInterface } from \"@langchain/core/embeddings\";\nimport { VectorStore } from \"@langchain/core/vectorstores\";\nimport { Document, DocumentInterface } from \"@langchain/core/documents\";\nimport { Callbacks } from \"@langchain/core/callbacks/manager\";\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type Metadata = Record<string, any>;\n\nexport type DistanceMetrics = \"DOT_PRODUCT\" | \"EUCLIDEAN_DISTANCE\";\n\nexport type SearchStrategy =\n  | \"VECTOR_ONLY\"\n  | \"TEXT_ONLY\"\n  | \"FILTER_BY_TEXT\"\n  | \"FILTER_BY_VECTOR\"\n  | \"WEIGHTED_SUM\";\n\nconst OrderingDirective: Record<DistanceMetrics, string> = {\n  DOT_PRODUCT: \"DESC\",\n  EUCLIDEAN_DISTANCE: \"\",\n};\n\nexport interface ConnectionOptions extends PoolOptions {}\n\ntype ConnectionWithUri = {\n  connectionOptions?: never;\n  connectionURI: string;\n};\n\ntype ConnectionWithOptions = {\n  connectionURI?: never;\n  connectionOptions: ConnectionOptions;\n};\n\ntype ConnectionConfig = ConnectionWithUri | ConnectionWithOptions;\n\ntype SearchConfig = {\n  searchStrategy?: SearchStrategy;\n  filterThreshold?: number;\n  textWeight?: number;\n  vectorWeight?: number;\n  vectorselectCountMultiplier?: number;\n};\n\nexport type SingleStoreVectorStoreConfig = ConnectionConfig & {\n  tableName?: string;\n  idColumnName?: string;\n  contentColumnName?: string;\n  vectorColumnName?: string;\n  metadataColumnName?: string;\n  distanceMetric?: DistanceMetrics;\n  useVectorIndex?: boolean;\n  vectorIndexName?: string;\n  vectorIndexOptions?: Metadata;\n  vectorSize?: number;\n  useFullTextIndex?: boolean;\n  searchConfig?: SearchConfig;\n};\n\n/**\n * Adds the connect attributes to the connection options.\n * @param config A SingleStoreVectorStoreConfig object.\n */\nfunction withConnectAttributes(\n  config: SingleStoreVectorStoreConfig\n): ConnectionOptions {\n  let newOptions: ConnectionOptions = {};\n  if (config.connectionURI) {\n    newOptions = {\n      uri: config.connectionURI,\n    };\n  } else if (config.connectionOptions) {\n    newOptions = {\n      ...config.connectionOptions,\n    };\n  }\n  const result: ConnectionOptions = {\n    ...newOptions,\n    connectAttributes: {\n      ...newOptions.connectAttributes,\n    },\n  };\n\n  if (!result.connectAttributes) {\n    result.connectAttributes = {};\n  }\n\n  result.connectAttributes = {\n    ...result.connectAttributes,\n    _connector_name: \"langchain js sdk\",\n    _connector_version: \"2.0.0\",\n    _driver_name: \"Node-MySQL-2\",\n  };\n\n  return result;\n}\n\n/**\n * Class for interacting with SingleStoreDB, a high-performance\n * distributed SQL database. It provides vector storage and vector\n * functions.\n */\nexport class SingleStoreVectorStore extends VectorStore {\n  connectionPool: Pool;\n\n  tableName: string;\n\n  idColumnName: string;\n\n  contentColumnName: string;\n\n  vectorColumnName: string;\n\n  metadataColumnName: string;\n\n  distanceMetric: DistanceMetrics;\n\n  useVectorIndex: boolean;\n\n  vectorIndexName: string;\n\n  vectorIndexOptions: Metadata;\n\n  vectorSize: number;\n\n  useFullTextIndex: boolean;\n\n  searchConfig: SearchConfig;\n\n  _vectorstoreType(): string {\n    return \"singlestore\";\n  }\n\n  constructor(\n    embeddings: EmbeddingsInterface,\n    config: SingleStoreVectorStoreConfig\n  ) {\n    super(embeddings, config);\n    this.connectionPool = createPool(withConnectAttributes(config));\n    this.tableName = config.tableName ?? \"embeddings\";\n    this.idColumnName = config.idColumnName ?? \"id\";\n    this.contentColumnName = config.contentColumnName ?? \"content\";\n    this.vectorColumnName = config.vectorColumnName ?? \"vector\";\n    this.metadataColumnName = config.metadataColumnName ?? \"metadata\";\n    this.distanceMetric = config.distanceMetric ?? \"DOT_PRODUCT\";\n    this.useVectorIndex = config.useVectorIndex ?? false;\n    this.vectorIndexName = config.vectorIndexName ?? \"\";\n    this.vectorIndexOptions = config.vectorIndexOptions ?? {};\n    this.vectorSize = config.vectorSize ?? 1536;\n    this.useFullTextIndex = config.useFullTextIndex ?? false;\n    this.searchConfig = config.searchConfig ?? {\n      searchStrategy: \"VECTOR_ONLY\",\n      filterThreshold: 1.0,\n      textWeight: 0.5,\n      vectorWeight: 0.5,\n      vectorselectCountMultiplier: 10,\n    };\n  }\n\n  /**\n   * Creates a new table in the SingleStoreDB database if it does not\n   * already exist.\n   */\n  async createTableIfNotExists(): Promise<void> {\n    let fullTextIndex = \"\";\n    if (this.useFullTextIndex) {\n      fullTextIndex = `, FULLTEXT(${this.contentColumnName})`;\n    }\n    if (this.useVectorIndex) {\n      let vectorIndexOptions = \"\";\n      if (Object.keys(this.vectorIndexOptions).length > 0) {\n        vectorIndexOptions = `INDEX_OPTIONS '${JSON.stringify(\n          this.vectorIndexOptions\n        )}'`;\n      }\n      await this.connectionPool\n        .execute(`CREATE TABLE IF NOT EXISTS ${this.tableName} (\n          ${this.idColumnName} BIGINT AUTO_INCREMENT PRIMARY KEY,\n          ${this.contentColumnName} LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,\n          ${this.vectorColumnName} VECTOR(${this.vectorSize}, F32) NOT NULL,\n          ${this.metadataColumnName} JSON,\n          VECTOR INDEX ${this.vectorIndexName} (${this.vectorColumnName}) ${vectorIndexOptions}\n          ${fullTextIndex});`);\n    } else {\n      await this.connectionPool\n        .execute(`CREATE TABLE IF NOT EXISTS ${this.tableName} (\n        ${this.idColumnName} BIGINT AUTO_INCREMENT PRIMARY KEY,\n        ${this.contentColumnName} LONGTEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci,\n        ${this.vectorColumnName} BLOB,\n        ${this.metadataColumnName} JSON\n        ${fullTextIndex});`);\n    }\n  }\n\n  /**\n   * Ends the connection to the SingleStoreDB database.\n   */\n  async end(): Promise<void> {\n    return this.connectionPool.end();\n  }\n\n  /**\n   * Sets the search configuration for the SingleStoreVectorStore instance.\n   * @param config A SearchConfig object.\n   */\n  async setSearchConfig(config: SearchConfig): Promise<void> {\n    this.searchConfig = {\n      searchStrategy: config.searchStrategy ?? \"VECTOR_ONLY\",\n      filterThreshold: config.filterThreshold ?? 1.0,\n      textWeight: config.textWeight ?? 0.5,\n      vectorWeight: config.vectorWeight ?? 0.5,\n      vectorselectCountMultiplier: config.vectorselectCountMultiplier ?? 10,\n    };\n  }\n\n  /**\n   * Adds new documents to the SingleStoreDB database.\n   * @param documents An array of Document objects.\n   */\n  async addDocuments(documents: Document[]): Promise<void> {\n    const texts = documents.map(({ pageContent }) => pageContent);\n    const vectors = await this.embeddings.embedDocuments(texts);\n    return this.addVectors(vectors, documents);\n  }\n\n  /**\n   * Adds new vectors to the SingleStoreDB database.\n   * @param vectors An array of vectors.\n   * @param documents An array of Document objects.\n   */\n  async addVectors(vectors: number[][], documents: Document[]): Promise<void> {\n    await this.createTableIfNotExists();\n    const { tableName } = this;\n\n    await Promise.all(\n      vectors.map(async (vector, idx) => {\n        try {\n          await this.connectionPool.query(\n            format(\n              `INSERT INTO ${tableName}(\n                ${this.contentColumnName},\n                ${this.vectorColumnName},\n                ${this.metadataColumnName})\n                VALUES (?, JSON_ARRAY_PACK('[?]'), ?);`,\n              [\n                documents[idx].pageContent,\n                vector,\n                JSON.stringify(documents[idx].metadata),\n              ]\n            )\n          );\n        } catch (error) {\n          console.error(`Error adding vector at index ${idx}:`, error);\n        }\n      })\n    );\n    if (this.useFullTextIndex || this.useVectorIndex) {\n      await this.connectionPool.query(`OPTIMIZE TABLE ${tableName} FLUSH;`);\n    }\n  }\n\n  /**\n   *\n   * Performs a similarity search on the texts stored in the SingleStoreDB\n   * using the specified search strategy and distance metric.\n   * @param query A string representing the query text.\n   * @param vector An array of numbers representing the query vector.\n   * @param k The number of nearest neighbors to return.\n   * @param filter Optional metadata to filter the texts by.\n   * @returns Top matching documents with score\n   */\n  async similaritySearchTextAndVectorWithScore(\n    query: string,\n    vector: number[],\n    k: number,\n    filter?: Metadata\n  ): Promise<[Document, number][]> {\n    if (!this.searchConfig.searchStrategy) {\n      throw new Error(\"Search strategy is required.\");\n    }\n    if (\n      this.searchConfig.searchStrategy !== \"VECTOR_ONLY\" &&\n      !this.useFullTextIndex\n    ) {\n      throw new Error(\n        \"Full text index is required for text-based search strategies.\"\n      );\n    }\n    if (\n      (this.searchConfig.searchStrategy === \"FILTER_BY_TEXT\" ||\n        this.searchConfig.searchStrategy === \"FILTER_BY_VECTOR\") &&\n      !this.searchConfig.filterThreshold &&\n      this.searchConfig.filterThreshold !== 0\n    ) {\n      throw new Error(\n        \"Filter threshold is required for filter-based search strategies.\"\n      );\n    }\n    if (\n      this.searchConfig.searchStrategy === \"WEIGHTED_SUM\" &&\n      ((!this.searchConfig.textWeight && this.searchConfig.textWeight !== 0) ||\n        (!this.searchConfig.vectorWeight &&\n          this.searchConfig.vectorWeight !== 0) ||\n        (!this.searchConfig.vectorselectCountMultiplier &&\n          this.searchConfig.vectorselectCountMultiplier !== 0))\n    ) {\n      throw new Error(\n        \"Text and vector weight and vector select count multiplier are required for weighted sum search strategy.\"\n      );\n    }\n    if (\n      this.searchConfig.searchStrategy === \"WEIGHTED_SUM\" &&\n      this.distanceMetric !== \"DOT_PRODUCT\"\n    ) {\n      throw new Error(\n        \"Weighted sum search strategy is only available for DOT_PRODUCT distance metric.\"\n      );\n    }\n    const filterThreshold = this.searchConfig.filterThreshold ?? 1.0;\n    // build the where clause from filter\n    const whereArgs: string[] = [];\n    const buildWhereClause = (record: Metadata, argList: string[]): string => {\n      const whereTokens: string[] = [];\n      for (const key in record)\n        if (record[key] !== undefined) {\n          if (\n            typeof record[key] === \"object\" &&\n            record[key] != null &&\n            !Array.isArray(record[key])\n          ) {\n            whereTokens.push(\n              buildWhereClause(record[key], argList.concat([key]))\n            );\n          } else {\n            whereTokens.push(\n              `JSON_EXTRACT_JSON(${this.metadataColumnName}, `.concat(\n                Array.from({ length: argList.length + 1 }, () => \"?\").join(\n                  \", \"\n                ),\n                \") = ?\"\n              )\n            );\n            whereArgs.push(...argList, key, JSON.stringify(record[key]));\n          }\n        }\n      return whereTokens.join(\" AND \");\n    };\n    const filterByTextClause = (): string => {\n      whereArgs.push(query, filterThreshold.toString());\n      return `MATCH (${this.contentColumnName}) AGAINST (?) > ?`;\n    };\n    const filterByVectorClause = (): string => {\n      whereArgs.push(JSON.stringify(vector), filterThreshold.toString());\n      return this.distanceMetric === \"DOT_PRODUCT\"\n        ? `${this.distanceMetric}(${this.vectorColumnName}, JSON_ARRAY_PACK(?)) > ?`\n        : `${this.distanceMetric}(${this.vectorColumnName}, JSON_ARRAY_PACK(?)) < ?`;\n    };\n    const whereClauses: string[] = [];\n    if (filter) {\n      whereClauses.push(buildWhereClause(filter, []));\n    }\n    if (this.searchConfig.searchStrategy === \"FILTER_BY_TEXT\") {\n      whereClauses.push(filterByTextClause());\n    }\n    if (this.searchConfig.searchStrategy === \"FILTER_BY_VECTOR\") {\n      whereClauses.push(filterByVectorClause());\n    }\n    const whereClause =\n      whereClauses.length > 0 ? `WHERE ${whereClauses.join(\" AND \")}` : \"\";\n\n    let queryText = \"\";\n    switch (this.searchConfig.searchStrategy) {\n      case \"TEXT_ONLY\":\n      case \"FILTER_BY_VECTOR\":\n        queryText = format(\n          `SELECT ${this.contentColumnName}, ${this.metadataColumnName},\n          MATCH (${this.contentColumnName}) AGAINST (?) as __score\n          FROM ${this.tableName} ${whereClause} ORDER BY __score DESC LIMIT ?;`,\n          [query, ...whereArgs, k]\n        );\n        break;\n      case \"VECTOR_ONLY\":\n      case \"FILTER_BY_TEXT\":\n        queryText = format(\n          `SELECT ${this.contentColumnName}, ${this.metadataColumnName},\n          ${this.distanceMetric}(${\n            this.vectorColumnName\n          }, JSON_ARRAY_PACK('[?]')) as __score\n          FROM ${this.tableName} ${whereClause} ORDER BY __score ${\n            OrderingDirective[this.distanceMetric]\n          } LIMIT ?;`,\n          [vector, ...whereArgs, k]\n        );\n        break;\n      case \"WEIGHTED_SUM\":\n        queryText = format(\n          `SELECT ${this.contentColumnName}, ${\n            this.metadataColumnName\n          }, __score1 * ? + __score2 * ? as __score\n          FROM (\n              SELECT ${this.idColumnName}, ${this.contentColumnName}, ${\n                this.metadataColumnName\n              }, MATCH (${this.contentColumnName}) AGAINST (?) as __score1 \n          FROM ${this.tableName} ${whereClause}) r1 FULL OUTER JOIN (\n              SELECT ${this.idColumnName}, ${this.distanceMetric}(${\n                this.vectorColumnName\n              }, JSON_ARRAY_PACK('[?]')) as __score2\n              FROM ${this.tableName} ${whereClause} ORDER BY __score2 ${\n                OrderingDirective[this.distanceMetric]\n              } LIMIT ?\n          ) r2 ON r1.${this.idColumnName} = r2.${\n            this.idColumnName\n          } ORDER BY __score ${OrderingDirective[this.distanceMetric]} LIMIT ?`,\n          [\n            this.searchConfig.textWeight,\n            this.searchConfig.vectorWeight,\n            query,\n            ...whereArgs,\n            vector,\n            ...whereArgs,\n            k * (this.searchConfig.vectorselectCountMultiplier ?? 10),\n            k,\n          ]\n        );\n        break;\n      default:\n        throw new Error(\"Invalid search strategy.\");\n    }\n    const [rows]: [\n      (\n        | RowDataPacket[]\n        | RowDataPacket[][]\n        | OkPacket\n        | OkPacket[]\n        | ResultSetHeader\n      ),\n      FieldPacket[],\n    ] = await this.connectionPool.query(queryText);\n    const result: [Document, number][] = [];\n    for (const row of rows as RowDataPacket[]) {\n      const rowData = row as unknown as Record<string, unknown>;\n      result.push([\n        new Document({\n          pageContent: rowData[this.contentColumnName] as string,\n          metadata: rowData[this.metadataColumnName] as Record<string, unknown>,\n        }),\n        Number(rowData.score),\n      ]);\n    }\n    return result;\n  }\n\n  /**\n   * Performs a similarity search on the texts stored in the SingleStoreDB\n   * @param query A string representing the query text.\n   * @param k The number of nearest neighbors to return. By default, it is 4.\n   * @param filter Optional metadata to filter the texts by.\n   * @param _callbacks - Callbacks object, not used in this implementation.\n   * @returns Top matching documents\n   */\n  async similaritySearch(\n    query: string,\n    k?: number,\n    filter?: Metadata,\n    _callbacks?: Callbacks | undefined\n  ): Promise<DocumentInterface<Metadata>[]> {\n    // @typescript-eslint/no-explicit-any\n    const queryVector = await this.embeddings.embedQuery(query);\n    return this.similaritySearchTextAndVectorWithScore(\n      query,\n      queryVector,\n      k ?? 4,\n      filter\n    ).then((result) => result.map(([doc]) => doc));\n  }\n\n  /**\n   * Performs a similarity search on the texts stored in the SingleStoreDB\n   * @param query A string representing the query text.\n   * @param k The number of nearest neighbors to return. By default, it is 4.\n   * @param filter Optional metadata to filter the texts by.\n   * @param _callbacks\n   * @returns Top matching documents with score\n   */\n  async similaritySearchWithScore(\n    query: string,\n    k?: number,\n    filter?: Metadata,\n    _callbacks?: Callbacks | undefined\n  ): Promise<[DocumentInterface<Metadata>, number][]> {\n    // @typescript-eslint/no-explicit-any\n    const queryVector = await this.embeddings.embedQuery(query);\n    return this.similaritySearchTextAndVectorWithScore(\n      query,\n      queryVector,\n      k ?? 4,\n      filter\n    );\n  }\n\n  /**\n   * Performs a similarity search on the vectors stored in the SingleStoreDB\n   * database.\n   * @param query An array of numbers representing the query vector.\n   * @param k The number of nearest neighbors to return.\n   * @param filter Optional metadata to filter the vectors by.\n   * @returns Top matching vectors with score\n   */\n  async similaritySearchVectorWithScore(\n    query: number[],\n    k: number,\n    filter?: Metadata\n  ): Promise<[Document, number][]> {\n    if (this.searchConfig.searchStrategy !== \"VECTOR_ONLY\") {\n      throw new Error(\n        \"similaritySearchVectorWithScore is only available for VECTOR_ONLY search strategy.\"\n      );\n    }\n    return this.similaritySearchTextAndVectorWithScore(\"\", query, k, filter);\n  }\n\n  /**\n   * Creates a new instance of the SingleStoreVectorStore class from a list\n   * of texts.\n   * @param texts An array of strings.\n   * @param metadatas An array of metadata objects.\n   * @param embeddings An Embeddings object.\n   * @param dbConfig A SingleStoreVectorStoreConfig object.\n   * @returns A new SingleStoreVectorStore instance\n   */\n  static async fromTexts(\n    texts: string[],\n    metadatas: object[],\n    embeddings: EmbeddingsInterface,\n    dbConfig: SingleStoreVectorStoreConfig\n  ): Promise<SingleStoreVectorStore> {\n    const docs = texts.map((text, idx) => {\n      const metadata = Array.isArray(metadatas) ? metadatas[idx] : metadatas;\n      return new Document({\n        pageContent: text,\n        metadata,\n      });\n    });\n    return SingleStoreVectorStore.fromDocuments(docs, embeddings, dbConfig);\n  }\n\n  /**\n   * Creates a new instance of the SingleStoreVectorStore class from a list\n   * of Document objects.\n   * @param docs An array of Document objects.\n   * @param embeddings An Embeddings object.\n   * @param dbConfig A SingleStoreVectorStoreConfig object.\n   * @returns A new SingleStoreVectorStore instance\n   */\n  static async fromDocuments(\n    docs: Document[],\n    embeddings: EmbeddingsInterface,\n    dbConfig: SingleStoreVectorStoreConfig\n  ): Promise<SingleStoreVectorStore> {\n    const instance = new this(embeddings, dbConfig);\n    await instance.addDocuments(docs);\n    return instance;\n  }\n}\n"],"mappings":"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"}