{"version":3,"file":"openapi.cjs","names":["yaml"],"sources":["../../src/util/openapi.ts"],"sourcesContent":["import * as yaml from \"js-yaml\";\nimport { OpenAPIV3, OpenAPIV3_1 } from \"openapi-types\";\n\nexport class OpenAPISpec {\n  constructor(public document: OpenAPIV3_1.Document) {}\n\n  get baseUrl() {\n    return this.document.servers ? this.document.servers[0].url : undefined;\n  }\n\n  getPathsStrict() {\n    if (!this.document.paths) {\n      throw new Error(\"No paths found in spec\");\n    }\n    return this.document.paths;\n  }\n\n  getParametersStrict() {\n    if (!this.document.components?.parameters) {\n      throw new Error(\"No parameters found in spec\");\n    }\n    return this.document.components.parameters;\n  }\n\n  getSchemasStrict() {\n    if (!this.document.components?.schemas) {\n      throw new Error(\"No schemas found in spec.\");\n    }\n    return this.document.components.schemas;\n  }\n\n  getRequestBodiesStrict() {\n    if (!this.document.components?.requestBodies) {\n      throw new Error(\"No request body found in spec.\");\n    }\n    return this.document.components.requestBodies;\n  }\n\n  getPathStrict(path: string) {\n    const pathItem = this.getPathsStrict()[path];\n    if (pathItem === undefined) {\n      throw new Error(`No path found for \"${path}\".`);\n    }\n    return pathItem;\n  }\n\n  getReferencedParameter(ref: OpenAPIV3_1.ReferenceObject) {\n    const refComponents = ref.$ref.split(\"/\");\n    const refName = refComponents[refComponents.length - 1];\n    if (this.getParametersStrict()[refName] === undefined) {\n      throw new Error(`No parameter found for \"${refName}\".`);\n    }\n    return this.getParametersStrict()[refName];\n  }\n\n  getRootReferencedParameter(\n    ref: OpenAPIV3_1.ReferenceObject\n  ): OpenAPIV3_1.ParameterObject {\n    let parameter = this.getReferencedParameter(ref);\n    while ((parameter as OpenAPIV3_1.ReferenceObject).$ref !== undefined) {\n      parameter = this.getReferencedParameter(\n        parameter as OpenAPIV3_1.ReferenceObject\n      );\n    }\n    return parameter as OpenAPIV3_1.ParameterObject;\n  }\n\n  getReferencedSchema(\n    ref: OpenAPIV3_1.ReferenceObject\n  ): OpenAPIV3_1.SchemaObject {\n    const refComponents = ref.$ref.split(\"/\");\n    const refName = refComponents[refComponents.length - 1];\n    const schema = this.getSchemasStrict()[refName];\n    if (schema === undefined) {\n      throw new Error(`No schema found for \"${refName}\".`);\n    }\n    return schema;\n  }\n\n  getSchema(\n    schema: OpenAPIV3_1.ReferenceObject | OpenAPIV3_1.SchemaObject\n  ): OpenAPIV3_1.SchemaObject {\n    if ((schema as OpenAPIV3_1.ReferenceObject).$ref !== undefined) {\n      return this.getReferencedSchema(schema as OpenAPIV3_1.ReferenceObject);\n    }\n    return schema;\n  }\n\n  getRootReferencedSchema(ref: OpenAPIV3_1.ReferenceObject) {\n    let schema = this.getReferencedSchema(ref);\n    while ((schema as OpenAPIV3_1.ReferenceObject).$ref !== undefined) {\n      schema = this.getReferencedSchema(schema as OpenAPIV3_1.ReferenceObject);\n    }\n    return schema as OpenAPIV3_1.ParameterObject;\n  }\n\n  getReferencedRequestBody(ref: OpenAPIV3_1.ReferenceObject) {\n    const refComponents = ref.$ref.split(\"/\");\n    const refName = refComponents[refComponents.length - 1];\n    const requestBodies = this.getRequestBodiesStrict();\n    if (requestBodies[refName] === undefined) {\n      throw new Error(`No request body found for \"${refName}\"`);\n    }\n    return requestBodies[refName];\n  }\n\n  getRootReferencedRequestBody(ref: OpenAPIV3_1.ReferenceObject) {\n    let requestBody = this.getReferencedRequestBody(ref);\n    while ((requestBody as OpenAPIV3_1.ReferenceObject).$ref !== undefined) {\n      requestBody = this.getReferencedRequestBody(\n        requestBody as OpenAPIV3_1.ReferenceObject\n      );\n    }\n    return requestBody as OpenAPIV3_1.RequestBodyObject;\n  }\n\n  getMethodsForPath(path: string): OpenAPIV3.HttpMethods[] {\n    const pathItem = this.getPathStrict(path);\n    // This is an enum in the underlying package.\n    // Werestate here to allow \"import type\" above and not cause warnings in certain envs.\n    const possibleMethods = [\n      \"get\",\n      \"put\",\n      \"post\",\n      \"delete\",\n      \"options\",\n      \"head\",\n      \"patch\",\n      \"trace\",\n    ];\n    return possibleMethods.filter(\n      (possibleMethod) =>\n        pathItem[possibleMethod as OpenAPIV3.HttpMethods] !== undefined\n    ) as OpenAPIV3.HttpMethods[];\n  }\n\n  getParametersForPath(path: string) {\n    const pathItem = this.getPathStrict(path);\n    if (pathItem.parameters === undefined) {\n      return [];\n    }\n    return pathItem.parameters.map((parameter) => {\n      if ((parameter as OpenAPIV3_1.ReferenceObject).$ref !== undefined) {\n        return this.getRootReferencedParameter(\n          parameter as OpenAPIV3_1.ReferenceObject\n        );\n      }\n      return parameter as OpenAPIV3_1.ParameterObject;\n    });\n  }\n\n  getOperation(path: string, method: OpenAPIV3.HttpMethods) {\n    const pathItem = this.getPathStrict(path);\n    if (pathItem[method] === undefined) {\n      throw new Error(`No ${method} method found for \"path\".`);\n    }\n    return pathItem[method];\n  }\n\n  getParametersForOperation(operation: OpenAPIV3_1.OperationObject) {\n    if (operation.parameters === undefined) {\n      return [];\n    }\n    return operation.parameters.map((parameter) => {\n      if ((parameter as OpenAPIV3_1.ReferenceObject).$ref !== undefined) {\n        return this.getRootReferencedParameter(\n          parameter as OpenAPIV3_1.ReferenceObject\n        );\n      }\n      return parameter as OpenAPIV3_1.ParameterObject;\n    });\n  }\n\n  getRequestBodyForOperation(\n    operation: OpenAPIV3_1.OperationObject\n  ): OpenAPIV3_1.RequestBodyObject {\n    const { requestBody } = operation;\n    if ((requestBody as OpenAPIV3_1.ReferenceObject)?.$ref !== undefined) {\n      return this.getRootReferencedRequestBody(\n        requestBody as OpenAPIV3_1.ReferenceObject\n      );\n    }\n    return requestBody as OpenAPIV3_1.RequestBodyObject;\n  }\n\n  static getCleanedOperationId(\n    operation: OpenAPIV3_1.OperationObject,\n    path: string,\n    method: OpenAPIV3_1.HttpMethods\n  ) {\n    let { operationId } = operation;\n    if (operationId === undefined) {\n      const updatedPath = path.replaceAll(/[^a-zA-Z0-9]/g, \"_\");\n      operationId = `${\n        updatedPath.startsWith(\"/\") ? updatedPath.slice(1) : updatedPath\n      }_${method}`;\n    }\n    return operationId\n      .replaceAll(/-/g, \"_\")\n      .replaceAll(/\\./g, \"_\")\n      .replaceAll(/\\//g, \"_\");\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  static alertUnsupportedSpec(document: Record<string, any>) {\n    const warningMessage =\n      \"This may result in degraded performance. Convert your OpenAPI spec to 3.1.0 for better support.\";\n    const swaggerVersion = document.swagger;\n    const openAPIVersion = document.openapi;\n    if (openAPIVersion !== undefined && openAPIVersion !== \"3.1.0\") {\n      console.warn(\n        `Attempting to load an OpenAPI ${openAPIVersion} spec. ${warningMessage}`\n      );\n    } else if (swaggerVersion !== undefined) {\n      console.warn(\n        `Attempting to load a Swagger ${swaggerVersion} spec. ${warningMessage}`\n      );\n    } else {\n      throw new Error(\n        `Attempting to load an unsupported spec:\\n\\n${JSON.stringify(\n          document,\n          null,\n          2\n        )}.`\n      );\n    }\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  static fromObject(document: Record<string, any>) {\n    OpenAPISpec.alertUnsupportedSpec(document);\n    return new OpenAPISpec(document as OpenAPIV3_1.Document);\n  }\n\n  static fromString(rawString: string) {\n    let document;\n    try {\n      document = JSON.parse(rawString);\n    } catch {\n      document = yaml.load(rawString);\n    }\n    return OpenAPISpec.fromObject(document);\n  }\n\n  static async fromURL(url: string) {\n    const response = await fetch(url);\n    const rawDocument = await response.text();\n    return OpenAPISpec.fromString(rawDocument);\n  }\n}\n"],"mappings":"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"}